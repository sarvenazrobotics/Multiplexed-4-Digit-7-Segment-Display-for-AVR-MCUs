#include <io.h>
#include <stdint.h>
#include <delay.h>

// Segments: A=PC0, B=PB5, C=PC1, D=PC2, E=PC3, F=PC4, G=PC5, DP=PD0
#define A(x) (x ? (PORTC|=(1<<0)):(PORTC &= ~(1<<0)))
#define B(x) (x ? (PORTB|=(1<<5)):(PORTB &= ~(1<<5)))
#define C(x) (x ? (PORTC|=(1<<1)):(PORTC &= ~(1<<1)))
#define D(x) (x ? (PORTC|=(1<<2)):(PORTC &= ~(1<<2)))
#define E(x) (x ? (PORTC|=(1<<3)):(PORTC &= ~(1<<3)))
#define F(x) (x ? (PORTC|=(1<<4)):(PORTC &= ~(1<<4)))
#define G(x) (x ? (PORTC|=(1<<5)):(PORTC &= ~(1<<5)))
#define DP(x)(x ? (PORTD|=(1<<0)):(PORTD &= ~(1<<0)))

// Digits: Common Cathode  LOW = ON, HIGH = OFF
#define DIG1(x) (x ? (PORTD &= ~(1<<1)) : (PORTD |= (1<<1)))  // LOW = ON
#define DIG2(x) (x ? (PORTD &= ~(1<<2)) : (PORTD |= (1<<2)))  // LOW = ON
#define DIG3(x) (x ? (PORTD &= ~(1<<3)) : (PORTD |= (1<<3)))  // LOW = ON
#define DIG4(x) (x ? (PORTD &= ~(1<<4)) : (PORTD |= (1<<4)))  // LOW = ON

const uint8_t seg[10] = {0x3F, 0x06, 0x5B, 0x4F, 0x66, 0x6D, 0x7D, 0x07, 0x7F, 0x6F};

void put_7seg(uint8_t dat)
{ 
    A(dat & 0x01);
    B(dat & 0x02);
    C(dat & 0x04);
    D(dat & 0x08);
    E(dat & 0x10);
    F(dat & 0x20);
    G(dat & 0x40);
    DP(dat & 0x80);
}

void show_digits(uint8_t d1, uint8_t d2, uint8_t d3, uint8_t d4)
{
    // Digit 1
    DIG1(0); DIG2(0); DIG3(0); DIG4(0); // All OFF (all HIGH)
    put_7seg(seg[d1]);
    DIG1(1); // ON (LOW)
    delay_ms(2);

    // Digit 2
    DIG1(0); // OFF (HIGH)
    put_7seg(seg[d2]);
    DIG2(1); // ON (LOW)
    delay_ms(2);

    // Digit 3
    DIG2(0); // OFF
    put_7seg(seg[d3]);
    DIG3(1); // ON
    delay_ms(2);

    // Digit 4
    DIG3(0); // OFF
    put_7seg(seg[d4]);
    DIG4(1); // ON
    delay_ms(2);
}

void main(void)
{
    DDRB |= (1<<5);     // PB5 output (Segment B)
    DDRC |= 0x3F;       // PC0-PC5 output (Segments A,C,D,E,F,G)
    DDRD |= 0x1F;       // PD0-PD4 output (DP, DIG1-DIG4)

    while (1)
    {
        show_digits(2, 0, 0, 0);
        delay_ms(5);
        show_digits(2,0,2,5);
    }
}